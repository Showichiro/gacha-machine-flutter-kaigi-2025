# 実装計画

## 実装タスク一覧

- [x] 1. プロジェクト基盤とインフラストラクチャの構築
  - 必要な依存関係（Howler.js）をプロジェクトに追加
  - TypeScript型定義と共通インターフェースの作成
  - プロジェクトディレクトリ構造の整備
  - 基本的な設定ファイルの準備
  - _Requirements: 全要件の基盤となる_

- [x] 2. データ永続化レイヤーの実装
- [x] 2.1 型安全なストレージサービスの構築
  - ブラウザLocalStorageへの型安全なアクセス機能
  - JSONシリアライズとデシリアライズのエラーハンドリング
  - ストレージ容量超過時のエラー処理
  - データ破損時の自動リカバリー機能
  - _Requirements: 4.1, 4.2, 4.3, 4.5_

- [x] 3. 景品管理のコアビジネスロジック
- [x] 3.1 景品データモデルとグローバル状態管理
  - Svelte 5 Runesを使用したリアクティブな景品状態の定義
  - 在庫ありの景品を自動抽出する派生状態の実装
  - ガチャ実行可否を判定する派生状態の実装
  - 景品データの型定義とバリデーションルール
  - _Requirements: 1.6, 1.7, 5.6_

- [x] 3.2 景品のCRUD操作機能
  - 景品の追加機能（一意なID生成、作成日時の自動設定）
  - 景品の更新機能（部分更新対応）
  - 景品の削除機能
  - 景品一覧取得機能
  - LocalStorageへの自動保存連携
  - _Requirements: 3.1, 3.2, 3.3, 3.5, 3.6, 3.7, 3.9, 4.1, 4.4_

- [x] 3.3 ガチャ抽選アルゴリズムと在庫管理
  - 在庫がある景品からランダムに抽選する機能
  - 抽選後の在庫自動減少処理
  - 在庫0の景品を抽選対象から除外
  - LocalStorageへの在庫更新の自動保存
  - _Requirements: 1.2, 1.4, 1.6, 4.4_

- [x] 4. アニメーションとオーディオの演出システム
- [x] 4.1 アニメーションエンジンの構築
  - スピニング演出用のspringアニメーション作成機能
  - リビール演出用のtweenedアニメーション作成機能
  - 結果表示用のspringアニメーション作成機能
  - アニメーションパラメータのカスタマイズ機能
  - _Requirements: 2.1, 2.4_

- [x] 4.2 オーディオプレイヤーの実装
  - Howler.jsを使用した効果音再生システム
  - スピン、リビール、結果の各効果音の管理
  - 音量制御とミュート機能
  - 音声ファイル読み込みエラーのサイレントハンドリング
  - _Requirements: 2.3_

- [ ] 5. ガチャ画面のUI実装
- [x] 5.1 画面レイアウトとステート管理
  - ガチャ画面の基本レイアウト構築
  - マルチステージ状態機械の実装（idle, spinning, revealing, result, complete）
  - 設定画面への遷移ボタンの配置
  - 当選景品の一時保持機能
  - _Requirements: 1.1, 5.1, 5.2_

- [x] 5.2 ガチャ実行フローとアニメーション連携
  - ガチャボタンのタップイベント処理
  - 状態遷移に応じたアニメーションのトリガー
  - 状態遷移に応じた効果音の再生
  - 演出中のユーザー操作の無効化
  - 景品抽選処理の実行と結果表示
  - _Requirements: 1.2, 1.3, 2.1, 2.2, 2.3, 2.4_

- [ ] 5.3 当選景品の表示と完了処理
  - 景品画像と名称の表示UI
  - 結果表示アニメーションの実行
  - 確認ボタンによるアイドル状態への復帰
  - 次回ガチャ実行の準備
  - _Requirements: 1.4, 1.5, 2.5_

- [ ] 5.4 在庫状態に応じたUI制御
  - 在庫なし時のガチャボタン非活性化
  - 在庫なしメッセージの表示
  - リアクティブな在庫状態の監視
  - _Requirements: 1.7, 5.6_

- [ ] 6. 設定画面のUI実装
- [ ] 6.1 景品一覧表示機能
  - 登録済み景品のリスト表示
  - 景品ごとの名前、画像、在庫数の表示
  - ガチャ画面への戻るボタン配置
  - リアクティブな景品データの自動更新
  - _Requirements: 3.1, 5.4, 5.5_

- [ ] 6.2 景品追加・編集フォームの実装
  - 新規景品追加ボタンと入力フォーム
  - 景品名、画像URL、在庫数の入力フィールド
  - 既存景品の編集モード切り替え
  - フォーム入力状態の管理
  - _Requirements: 3.2, 3.5, 3.6, 3.7_

- [ ] 6.3 バリデーションとエラーハンドリング
  - 景品名の必須チェック
  - 在庫数の0以上チェック
  - フィールドごとのエラーメッセージ表示
  - 保存失敗時のエラーメッセージ表示
  - _Requirements: 3.4, 4.5_

- [ ] 6.4 景品削除機能の実装
  - 削除ボタンの配置
  - 削除確認ダイアログの表示
  - 削除確定時の景品リストからの除去
  - LocalStorageへの自動保存
  - _Requirements: 3.8, 3.9_

- [ ] 7. ルートコンポーネントと画面遷移
- [ ] 7.1 アプリケーション全体の構成
  - ルートコンポーネント（App.svelte）の実装
  - 画面状態管理（gacha/settings）
  - ガチャ画面と設定画面の切り替え機能
  - アプリケーション起動時のガチャ画面表示
  - _Requirements: 5.1, 5.3_

- [ ] 8. データ初期化とアプリケーション起動
- [ ] 8.1 起動時のデータロードと整合性チェック
  - LocalStorageからの景品データ読み込み
  - データ存在チェックと復元処理
  - データ破損時の自動初期化
  - LocalStorage可用性チェック
  - _Requirements: 4.2, 4.3_

- [ ] 9. 統合とエンドツーエンドテスト
- [ ] 9.1 コア機能の統合テスト
  - ガチャ実行から在庫減少、LocalStorage保存までの一連の流れ
  - 景品追加から保存、アプリ再起動、データ復元までの一連の流れ
  - 全景品在庫0時のガチャボタン非活性化の確認
  - 画面遷移時の状態保持の確認
  - 音声再生とアニメーション連携の確認
  - _Requirements: 1.1-1.7, 2.1-2.5, 3.1-3.9, 4.1-4.5, 5.1-5.6_

- [ ] 9.2 エンドツーエンドシナリオテスト
  - 来場者フロー（ガチャボタンタップ → 演出 → 景品獲得 → 再実行）
  - 運営者フロー（設定画面 → 景品追加 → 編集 → 削除 → ガチャ画面）
  - 在庫管理フロー（在庫1でガチャ実行 → 在庫0 → ボタン非活性化）
  - データ永続化フロー（景品設定 → ブラウザリロード → 設定保持確認）
  - エラーハンドリングフロー（空の景品名で保存 → エラー表示確認）
  - _Requirements: 全要件_

- [ ] 10. パフォーマンス最適化とポリッシュ
- [ ] 10.1 パフォーマンスの検証と最適化
  - アニメーションの滑らかさ確認（60fps目標）
  - LocalStorage読み書き速度の測定（100件で10ms以内）
  - ガチャ抽選アルゴリズムの速度確認（1000件で100ms以内）
  - 景品画像の遅延読み込み実装（初回表示2秒以内）
  - _Requirements: パフォーマンス要件_

- [ ] 10.2 最終的なUIポリッシュとUX改善
  - アニメーションのタイミング調整
  - 効果音のボリューム調整
  - レスポンシブデザインの確認
  - エラーメッセージの文言調整
  - 全体的なビジュアルデザインの調整
  - _Requirements: 全UI要件_

## タスク実行ガイドライン

### タスクの進め方
1. 上から順番にタスクを実行する
2. 各タスク完了時に`[x]`にマークを更新する
3. 各メジャータスク完了時に動作確認を行う
4. 問題があれば前のタスクに戻って修正する

### 実装時の注意事項
- TypeScriptの型安全性を常に維持する
- Svelte 5のRunesを正しく使用する（$state, $derived, $effect）
- エラーハンドリングを適切に実装する
- LocalStorageへの保存は自動で行う（手動保存不要）
- アニメーションと音声は演出のタイミングを意識する

### テスト実施のタイミング
- タスク3完了時: 景品管理のユニットテスト
- タスク8完了時: データ永続化の統合テスト
- タスク9完了時: 全機能のE2Eテスト
- タスク10完了時: パフォーマンステスト
