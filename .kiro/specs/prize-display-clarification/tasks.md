# Implementation Plan

## Phase 1: データモデルとコアロジックの拡張

- [ ] 1. 景品データモデルに説明フィールドを追加
- [x] 1.1 Prize型にdescriptionフィールドを追加
  - Prize型定義にdescription?: stringフィールドを追加
  - 既存のAddPrizeRequest、UpdatePrizeRequestにdescriptionを追加
  - バリデーションルール: 最大500文字
  - _Requirements: 1.4_

- [x] 1.2 PrizeServiceにdescription対応を追加
  - addPrize、updatePrizeメソッドでdescriptionを処理
  - LocalStorageへの保存時にdescriptionを含める
  - 既存データの後方互換性を確保(descriptionなしでも動作)
  - _Requirements: 1.4_

- [x] 2. 確率計算ロジックを実装
- [x] 2.1 ProbabilityCalculatorサービスを作成
  - 全景品の確率を計算する機能(在庫数ベース)
  - 計算アルゴリズム: (景品の在庫数 / 総在庫数) × 100
  - 小数点以下2桁で四捨五入
  - 総在庫数が0の場合は全景品0%を返す
  - _Requirements: 2.1, 2.2, 2.4_

- [x] 2.2 確率計算の正確性を検証
  - 全景品の確率合計が100%になることを確認
  - 在庫数変動時の再計算が正しく動作することを確認
  - エッジケース(在庫0、景品1個のみ等)のテスト
  - _Requirements: 2.3, 2.5_

- [x] 3. レアリティ分類ロジックを実装
- [x] 3.1 RarityClassifierサービスを作成
  - 確率に基づくレアリティ自動分類機能
  - 分類ルール: 10%以上=ノーマル、3-10%=レア、3%未満=超レア
  - レアリティごとの色コードマッピング
  - レアリティごとのアイコンマッピング
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 3.2 レアリティ表示の視覚エフェクトを定義
  - 各レアリティの色コード定義(Normal, Rare, SuperRare)
  - 各レアリティのアイコン定義
  - 背景エフェクトのCSS定義(金色の枠、キラキラエフェクト等)
  - _Requirements: 4.5_

- [x] 4. 景品表示サービスを実装
- [x] 4.1 PrizeDisplayServiceを作成
  - 景品表示情報を生成する機能(確率、レアリティ、在庫警告を含む)
  - ProbabilityCalculator、RarityClassifierを統合
  - PrizeDisplayInfo型の返却(prize, probability, rarity, isLowStock)
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 3.1, 4.1_

- [x] 4.2 景品統計情報の計算機能を追加
  - 統計情報を計算する機能(総数、在庫あり、在庫切れ、総在庫数)
  - PrizeStats型の返却
  - 在庫切れ景品の警告判定
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

## Phase 2: UIコンポーネントの実装

- [x] 5. 景品一覧ウィジェットを作成
- [x] 5.1 PrizeListWidget基本構造を実装
  - Svelteコンポーネントの骨格作成
  - props定義(mode, onPrizeClick, showControls)
  - prizesStoreからのデータ取得
  - 景品が0個の場合のメッセージ表示
  - _Requirements: 1.1, 1.6_

- [x] 5.2 景品一覧の表示レイアウトを実装
  - 各景品の画像、名称、説明の表示
  - 確率のパーセンテージ表示
  - 在庫数の「残り○個」形式表示
  - レアリティの視覚的区別(色分け、アイコン、背景エフェクト)
  - 視覚的に整理されたグリッドまたはリストレイアウト
  - _Requirements: 1.2, 1.3, 1.4, 1.5, 2.1, 3.1, 4.1, 4.4, 4.5_

- [x] 5.3 在庫状況の視覚的表現を追加
  - 在庫0の景品をグレーアウト表示
  - 在庫5個以下の景品に「残りわずか」警告表示
  - 在庫変動時のリアクティブな更新
  - _Requirements: 3.1, 3.3, 3.4, 3.5_

- [x] 6. 景品詳細モーダルを作成
- [x] 6.1 PrizeDetailModal基本構造を実装
  - モーダルコンポーネントの骨格作成
  - props定義(isOpen, prizeId, onClose)
  - モーダルのオープン・クローズ機能
  - オーバーレイと閉じるボタン
  - _Requirements: 5.1, 5.5_

- [x] 6.2 景品詳細情報の表示を実装
  - 景品の拡大画像表示
  - 景品名、説明、確率、在庫数の表示
  - レアリティ情報の表示
  - 追加属性(カテゴリ、タグ)がある場合の表示
  - _Requirements: 5.2, 5.3, 5.4_

- [x] 7. 景品統計ウィジェットを作成
- [x] 7.1 PrizeStatsWidget基本構造を実装
  - Svelteコンポーネントの骨格作成
  - prizesStoreからのデータ取得
  - PrizeDisplayServiceからの統計情報取得
  - _Requirements: 8.1_

- [x] 7.2 統計情報の表示を実装
  - 登録景品総数の表示
  - 在庫がある景品数の表示
  - 在庫切れ景品数の表示
  - 総在庫数の表示
  - 在庫切れ景品がある場合の警告メッセージ
  - _Requirements: 8.2, 8.3, 8.4, 8.5, 8.6_

## Phase 3: ソート・フィルタ機能の実装

- [x] 8. フィルタ状態管理ストアを作成
- [x] 8.1 filterStoreを実装
  - Svelte Runesを使用した状態管理
  - ソート基準の状態(probability, name, stock)
  - フィルタ条件の状態(stockAvailable, rarity)
  - setSortBy、setFilterBy、clearFilterメソッド
  - _Requirements: 7.1, 7.3_

- [x] 9. ソート機能を実装
- [x] 9.1 ソートオプションUIを追加
  - ソート選択ドロップダウンまたはボタン群
  - 確率順、名前順、在庫数順の選択肢
  - 選択されたソート基準の視覚的表示
  - _Requirements: 7.1_

- [x] 9.2 ソートロジックを実装
  - 景品一覧をソート基準に応じて並び替え
  - 降順・昇順の切り替え(必要に応じて)
  - リアクティブなソート適用
  - _Requirements: 7.2_

- [x] 10. フィルタ機能を実装
- [x] 10.1 フィルタオプションUIを追加
  - 在庫あり/なしフィルタのトグルまたはチェックボックス
  - レアリティ別フィルタの選択肢
  - 現在のフィルタ状態の視覚的表示
  - フィルタクリアボタン
  - _Requirements: 7.3, 7.5_

- [x] 10.2 フィルタロジックを実装
  - 在庫条件に基づく景品絞り込み
  - レアリティ条件に基づく景品絞り込み
  - 複数フィルタの組み合わせ適用
  - フィルタクリア時の全景品再表示
  - _Requirements: 7.4, 7.6_

## Phase 4: 既存画面への統合

- [x] 11. ガチャ画面に景品一覧を統合
- [x] 11.1 GachaScreenにPrizeListWidgetを配置
  - ガチャボタンの下部または横に景品一覧ウィジェットを配置
  - compactモードで表示(スペース節約)
  - 景品クリック時にPrizeDetailModalを開く
  - 既存のガチャ実行機能との共存
  - _Requirements: 1.1, 5.1_

- [x] 11.2 ガチャ画面のレイアウト調整
  - 景品一覧が追加されても見やすいレイアウト
  - レスポンシブデザインの調整
  - 既存のアニメーション演出との干渉回避
  - _Requirements: 1.5_

- [x] 12. 設定画面に景品情報を統合
- [x] 12.1 SettingsScreenにPrizeStatsWidgetを配置
  - 景品追加ボタンの近くに統計情報ウィジェットを配置
  - 統計情報のリアルタイム更新
  - _Requirements: 6.1, 8.1_

- [ ] 12.2 SettingsScreenにPrizeListWidgetを配置
  - 既存の景品一覧の代わりにPrizeListWidgetを使用
  - detailedモードで表示(詳細情報含む)
  - ソート・フィルタコントロールを表示
  - 編集・削除ボタンとの統合
  - _Requirements: 6.2, 7.1, 7.3_

- [ ] 12.3 設定画面のレイアウト調整
  - 統計情報と景品一覧が見やすいレイアウト
  - 確率合計が100%でない場合の警告表示
  - 在庫0の景品への警告アイコン表示
  - _Requirements: 6.3, 6.4, 6.6_

- [ ] 13. 設定画面のフォームに説明フィールドを追加
- [x] 13.1 景品追加・編集フォームにdescriptionを追加
  - テキストエリア入力欄の追加
  - 文字数カウンターの表示(最大500文字)
  - バリデーションエラーメッセージの表示
  - _Requirements: 1.4_

## Phase 5: テストとバリデーション

- [ ] 14. ユニットテストを実装
- [ ] 14.1 ProbabilityCalculatorのテスト
  - 正常系: 確率計算の正確性
  - 境界値: 在庫0、景品1個のみ
  - 確率合計が100%になることの検証
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [ ] 14.2 RarityClassifierのテスト
  - 確率に基づくレアリティ分類の正確性
  - 境界値: 10%, 3%ちょうどの分類
  - 色コード・アイコン取得の正確性
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 14.3 PrizeDisplayServiceのテスト
  - 景品表示情報の生成正確性
  - 統計情報の計算正確性
  - エッジケース: 景品0個、全在庫0
  - _Requirements: 全要件_

- [ ] 15. 統合テストを実装
- [ ] 15.1 景品一覧表示の統合テスト
  - PrizeListWidget → prizesStore → PrizeDisplayServiceの連携
  - 在庫変動時の確率リアルタイム更新
  - ソート・フィルタ機能の動作
  - _Requirements: 1.1, 2.3, 3.5, 7.2, 7.4_

- [ ] 15.2 景品詳細モーダルの統合テスト
  - PrizeListWidget → PrizeDetailModalの連携
  - モーダル開閉の正常動作
  - 詳細情報の正確な表示
  - _Requirements: 5.1, 5.2, 5.3, 5.5_

- [ ] 15.3 統計情報表示の統合テスト
  - PrizeStatsWidget → prizesStore → PrizeDisplayServiceの連携
  - 景品追加・削除時の自動更新
  - 警告メッセージの表示条件
  - _Requirements: 8.1, 8.6_

- [ ] 16. E2Eテストを実装
- [ ] 16.1 来場者シナリオのE2Eテスト
  - ガチャ画面での景品一覧表示確認
  - 景品タップで詳細モーダル表示確認
  - 詳細情報(確率、在庫、説明)の表示確認
  - モーダルクローズの動作確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 5.1, 5.2, 5.3_

- [ ] 16.2 運営者シナリオのE2Eテスト
  - 設定画面での統計サマリー表示確認
  - 景品一覧での確率・在庫表示確認
  - ソート機能の動作確認
  - フィルタ機能の動作確認
  - 景品追加時のdescription入力確認
  - _Requirements: 6.1, 6.2, 7.1, 7.2, 7.3, 7.4, 8.1, 8.2_

- [ ] 17. エラーハンドリングとバリデーション
- [ ] 17.1 バリデーションエラー処理を実装
  - description文字数超過時のエラー表示
  - 確率合計が100%でない場合の警告表示
  - フォーム保存失敗時のエラーメッセージ
  - _Requirements: 2.5, 6.6_

- [ ] 17.2 システムエラー処理を実装
  - LocalStorage書き込みエラーのハンドリング
  - 確率計算エラー(0除算)のハンドリング
  - 景品ID不存在時のエラーハンドリング
  - _Requirements: 全要件_

## Phase 6: パフォーマンス最適化

- [ ] 18. パフォーマンス最適化を実施
- [ ] 18.1 確率計算のパフォーマンスを検証
  - 景品数100個で100ms以内の計算時間を確認
  - 景品数1000個で1秒以内の計算時間を確認
  - 必要に応じてメモ化やキャッシュを導入
  - _Requirements: 2.3_

- [ ] 18.2 UIレンダリングのパフォーマンスを検証
  - 景品一覧(100個)のレンダリングが500ms以内を確認
  - ソート・フィルタの反映が200ms以内を確認
  - 必要に応じて仮想スクロールを導入
  - _Requirements: 1.1, 7.2, 7.4_
